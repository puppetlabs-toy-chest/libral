# Integrating Libral with Puppet

This folder contains a simple example of integrating Puppet with Libral, specifically exposing Libral providers to Puppet and using Puppet as a Libral provider. This is not intended to be a complete solution, more an early working prototype.

You can see this working with the accompanying Dockerfile.The image contains both Puppet and Libral, along with Ralsh.

```
docker build -t puppet/puppet-libral-example .
```

Running this goes straight to running `puppet resource` for the new type.

```
$ docker run -it puppet/puppet-libral | head
Warning: Found multiple default providers for apt_libral: ralsh, simple; using ralsh
apt_libral { 'adduser':
  ensure   => '3.113+nmu3ubuntu4',
  platform => 'all',
}
apt_libral { 'apt':
  ensure   => '1.2.24',
  platform => 'amd64',
}
apt_libral { 'base-files':
```

Note above that Puppet detected two providers, one which uses ralsh and one which hits the provider directly. As part of the proof-of-concept you can force the usage of the `simple` provider with facter.

```
$ docker run -it -e FACTER_libral_provider=simple puppet/puppet-libral | head
apt_libral { 'adduser':
  ensure   => '3.113+nmu3ubuntu4',
  platform => 'all',
}
apt_libral { 'apt':
  ensure   => '1.2.24',
  platform => 'amd64',
}
apt_libral { 'base-files':
  ensure   => '9.4ubuntu4.5',
```

This example also contains an example Libral provider which uses Puppet under the hood. This is incredibly blunt, in that it shells out and then naively parses the returned YAML (MRuby isn't built with the YAML gem yet), but it demonstrates this works. For instance lets run our new provider via Ralsh.

```
$ docker run --entrypoint ralsh puppet/puppet-libral -l none group::puppet | head
group::puppet { 'adm':
  ensure => 'present',
  gid    => '4',
}
group::puppet { 'audio':
  ensure => 'present',
  gid    => '29',
}
group::puppet { 'backup':
  ensure => 'present',
```

Compare that with the groupadd provider which already ships with libral:

```
$ docker run --entrypoint ralsh puppet/puppet-libral -l none group::puppet root
group::puppet { 'root':
  ensure => 'present',
  gid    => '0',
}

$ docker run --entrypoint ralsh puppet/puppet-libral -l none group::groupadd root
group::groupadd { 'root':
  ensure => 'present',
  gid    => '0',
}
```

## Notes

* This only looks at `list` operations so far
* The Puppet types could be autogenerated from the libral providers, or loaded dynamically at runtime
* The libral types, and provider code, could be autogenerated from the Puppet types. Some prior-art around extraction in https://github.com/puppetlabs/pcore-to-jsonschema
* The providers are nearly 100% boilerplate, which should mean we can have a simple base class which does all the work for any libral provider
* The exception is type-specific fields, which again can be autogenerated or parsed from the provider/ralsh at runtime
* I've implemented both a simple provider and a ralsh provider. A JSON provider would be simple enough to add, and once https://github.com/puppetlabs/libral/pull/25 is working it should be possible to use the native Ruby interface. I'm doing this for completeness, in reality we'd probably pick one
